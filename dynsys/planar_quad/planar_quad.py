import sympy as sp
import numpy as np
from dynsys.ctrl_affine_sys import CtrlAffineSys

class PLANAR_QUAD(CtrlAffineSys):
    def __init__(self, params=None):
        super().__init__(params)
    
    def define_system_symbolic(self):
        # Symbolic states
        px, pz, phi, vx, vz, phi_dot = sp.symbols('px pz phi vx vz phi_dot')
        x = sp.Matrix([px, pz, phi, vx, vz, phi_dot])
        
        l = self.params['l'] # (m) half-width of quadrotor
        m = self.params['m'] # (kg) mass of the quadrotor
        grav = self.params['g'] # (m/s^2) gravity
        J = self.params['J'] # (kgm^2), moment of inertia

        f = sp.Matrix([
            x[3] * sp.cos(x[2]) - x[4] * sp.sin(x[2]),   # px_dot
            x[3] * sp.sin(x[2]) + x[4] * sp.cos(x[2]),   # pz_dot
            x[5],                                        # phi_dot
            x[5] * x[4] - grav * sp.sin(x[2]),           # vx_dot
            -x[5] * x[3] - grav * sp.cos(x[2]),          # vz_dot
            sp.Integer(0)                                # phi_ddot
        ])

        g = sp.Matrix([
            [0,              0],
            [0,              0],
            [0,              0],
            [0,              0],
            [1/m,            1/m],
            [l/J,           -l/J]
        ])

        # Define the symbolic uncertainty term Y(x)
        Y = sp.Matrix([[0], 
                       [0],
                       [0],
                       [0],
                       [0],
                       [0]])
        
        # Define symbolic uncertainty parameters
        a0 = sp.symbols('a0')
        a = sp.Matrix([a0])

        return x, f, g, Y, a

    # CCM functions
    """
    def W_fcn(self, x, a_hat = None):
        # This function was generated by the Symbolic Math Toolbox version 24.2.
        # 01-Oct-2025 19:12:38

        x3 = x[2]
        x4 = x[3]
        t2 = x3**2
        t3 = x3**3
        t4 = x4**2
        t6 = x4**3
        t8 = x3*1.38151860721e-2
        t9 = x3*5.52052674756e-1
        t11 = x3*3.75411181036e-1
        t13 = x4*1.68064496529e-2
        t14 = x3*5.17697705542e-2
        t15 = x3*x4*1.6976747707e-2
        t16 = x3*8.03857301979e-2
        t17 = x4*6.7039540903e-2
        t19 = x4*1.83228390892e-2
        t20 = x4*5.35906831544e-2
        t22 = x4*1.4165847977e-2
        t23 = x3*x4*1.52630123317e-2
        t24 = x4*1.41015869075e-3
        t25 = x3*x4*3.08826079831e-2
        t26 = x4*1.03962668686e-2
        t27 = x3*2.71666514078e-3
        t28 = x3*x4*1.93285368739e-2
        t30 = x3*8.817349728100001e-3
        t36 = x3*2.46814993982e-3
        t39 = x3*x4*6.18282722687e-2
        t46 = x3*x4*1.01781569116e-2
        t49 = x4*5.05945961426e-4
        t76 = x3*x4*8.40047620652e-4
        t5 = t2**2
        t7 = t4**2
        t10 = -t8
        t12 = -t11
        t18 = t4*x3*2.0847447174e-3
        t21 = t2*1.33929951e-2
        t29 = -t14
        t31 = -t16
        t32 = t2*x4*1.35197524008e-2
        t33 = t2*2.36856090287e-1
        t34 = -t17
        t35 = -t19
        t38 = -t22
        t40 = t2*2.62547435779e-1
        t41 = t2*2.28269525168e-2
        t42 = -t26
        t43 = t3*9.16349907651e-2
        t44 = -t28
        t45 = t3*1.50239341274e-2
        t47 = -t30
        t48 = t3*2.55451585813e-2
        t50 = t3*1.01859067189e-1
        t51 = t2*5.55667624346e-2
        t53 = t4*1.57097148958e-3
        t54 = t4*1.12495536383e-3
        t56 = t4*x3*8.15297254669e-3
        t57 = t2*x4*3.28265847427e-2
        t59 = t6*7.87086783278e-4
        t60 = t4*6.600227688959999e-4
        t61 = t4*6.60369223825e-4
        t62 = t2*x4*1.6418451039e-2
        t63 = t2*4.79617010882e-3
        t64 = t3*7.2002349342e-3
        t65 = -t46
        t66 = t3*1.01807571449e-3
        t68 = t2*3.43442142861e-3
        t69 = t6*1.44505713573e-3
        t70 = -t49
        t72 = t6*1.39169856005e-3
        t74 = t6*1.21178721693e-3
        t75 = t2*x4*1.4444121593e-2
        t78 = t4*x3*7.841147020349999e-3
        t79 = t3*1.02324174471e-3
        t82 = t4*x3*7.61763126008e-3
        t85 = t3*5.65485508727e-4
        t86 = t6*1.66818841413e-4
        t87 = t3*x4*2.46440527133e-3
        t90 = t4*8.98835257492e-4
        t93 = t4*x3*2.27071204693e-3
        t94 = t2*x4*7.15821848072e-3
        t95 = t6*x3*2.05765602827e-3
        t96 = t3*x4*8.492757914380001e-3
        t100 = t4*2.75378638139e-4
        t101 = t6*x3*1.00907851284e-3
        t103 = t3*x4*2.2581281035e-3
        t104 = t6*2.29403777449e-4
        t105 = t4*x3*2.0031239807e-3
        t106 = t6*1.99322878131e-4
        t107 = t3*x4*6.00003463389e-3
        t108 = t3*x4*3.98473836505e-3
        t110 = t6*x3*1.94850948378e-3
        t111 = t4*9.624057433509999e-4
        t112 = t4*x3*1.96678991273e-3
        t116 = t2*x4*1.2556918725e-3
        t117 = t6*2.03146915163e-4
        t122 = t2*x4*1.28427445023e-4
        t127 = t3*x4*6.16699231415e-4
        t130 = t2*t4*7.59961438459e-4
        t131 = t2*x4*4.94475643172e-5
        t133 = t3*x4*8.91778016283e-4
        t145 = t4*x3*3.89354118965e-4
        t148 = t6*x3*1.25361383469e-5
        t149 = t2*t4*7.05514932906e-3
        t151 = t6*x3*5.59432417061e-5
        t152 = t6*x3*8.84788907743e-5
        t154 = t6*x3*8.74320987511e-5
        t155 = t2*t4*5.36008671229e-3
        t156 = t2*t4*2.25960805263e-3
        t157 = t2*t4*7.35544611644e-4
        t159 = t2*t4*3.79546900681e-5
        t162 = t2*t4*4.01270321585e-4
        t37 = -t21
        t52 = t7*1.4183614154e-4
        t55 = t5*5.40921704924e-3
        t58 = t5*6.8428923909e-4
        t67 = t5*4.28941279995e-3
        t71 = t5*4.9468405077e-3
        t73 = -t50
        t80 = t5*7.88084242136e-3
        t81 = t5*8.501095961720001e-3
        t83 = -t53
        t84 = -t57
        t89 = -t59
        t91 = -t60
        t92 = -t62
        t97 = -t64
        t98 = -t66
        t99 = -t68
        t102 = -t69
        t109 = t7*1.35415961092e-4
        t113 = -t74
        t114 = -t75
        t115 = t7*3.37800764637e-5
        t120 = -t82
        t121 = t7*1.76899372875e-5
        t123 = t5*3.18924103355e-5
        t124 = -t85
        t125 = t7*2.23418313182e-5
        t126 = -t87
        t128 = -t93
        t129 = -t95
        t132 = -t96
        t134 = -t101
        t135 = -t103
        t136 = -t104
        t137 = -t105
        t138 = t7*3.76598755449e-5
        t139 = t7*1.22473208179e-5
        t140 = -t106
        t141 = -t107
        t142 = -t108
        t143 = -t110
        t144 = -t112
        t146 = -t116
        t158 = -t151
        t160 = -t154
        t161 = -t155
        t163 = -t159
        t164 = -t162
        t168 = t12+t24+t43+t56+t86+t122
        t77 = -t52
        t88 = -t58
        t118 = -t80
        t119 = -t81
        t147 = -t121
        t150 = -t125
        t153 = -t139
        t165 = t31+t32+t34+t48+t78+t89
        t166 = t10+t20+t45+t84+t113+t120
        t167 = t9+t13+t73+t102+t114+t137
        t169 = t29+t38+t72+t79+t92+t144
        t170 = t18+t47+t70+t98+t131+t140
        t171 = t36+t42+t94+t97+t117+t128
        t172 = t27+t35+t124+t136+t145+t146
        t173 = t15+t40+t55+t90+t109+t126+t148+t156-4.79295044922e-1
        t175 = t39+t41+t61+t67+t132+t138+t143+t161+8.58616463956e-2
        t179 = t63+t76+t100+t115+t123+t133+t160+t163-1.99076776392e-2
        t174 = t25+t51+t77+t83+t119+t129+t130+t141-3.09791290468e-2
        t176 = t33+t54+t65+t71+t134+t135+t149+t150-3.56221429469e-1
        t177 = t37+t44+t88+t91+t127+t152+t153+t164+1.03286559859e-1
        t178 = t23+t99+t111+t118+t142+t147+t157+t158-6.697189377109999e-2
        et1 = t2*9.790347941220001e-3+t4*2.09625404033e-3-t5*3.02197057472e-2-t7*1.24989273028e-4-t2*t4*1.84381497526e-3
        et2 = t3*x4*(-1.18474849205e-2)-t6*x3*1.12921984499e-3+x3*x4*2.60977416135e-3+4.99757171046e-1
        et3 = t2*3.37181495112e-3+t4*2.10812843703e-3-t5*5.22957260758e-3+t7*4.54228038143e-5+t2*t4*4.12422911179e-4
        et4 = t3*x4*(-5.08294605886e-3)-t6*x3*1.83915612435e-3-x3*x4*1.4597313393e-2+3.36181690489e-1
        et5 = t2*1.09624979786e-4-t4*1.88989321782e-4+t5*2.33873547771e-4+t7*1.05598360031e-6-t2*t4*3.38979026965e-5
        et6 = t3*x4*2.20147940987e-4-t6*x3*9.997075268549999e-5-x3*x4*2.36028893555e-3+3.80057325514e-2
        et7 = t2*(-1.15605065576e-1)-t4*5.76118600295e-3-t5*7.42462243068e-4-t7*1.92316179545e-5+t2*t4*1.42695556453e-3
        et8 = t3*x4*4.24730057945e-3-t6*x3*9.993018930030001e-4-x3*x4*1.18532669786e-1+8.08076585339e-1
        et9 = t2*6.938249232e-2+t4*1.32466169327e-3-t5*6.43162052062e-3+t7*1.8831360873e-4+t2*t4*2.0908541713e-3
        et10 = t3*x4*(-9.19521465711e-3)+t6*x3*1.09027165816e-3+x3*x4*6.33621761412e-3+6.68094673413e-1
        et11 = t2*(-6.442187942700001e-2)+t4*4.83036532284e-4-t5*6.12978532306e-3-t7*1.84988644948e-4-t2*t4*1.87911896234e-3
        et12 = t3*x4*(-6.34398454414e-3)+t6*x3*6.38164156979e-4+x3*x4*1.12705665988e-2+1.18102174216
        W = np.reshape([et1+et2,t171,t179,t173,t167,t174,t171,et3+et4,t170,t168,t176,t169,t179,t170,et5+et6,t177,t172,t178,t173,t168,t177,et7+et8,t165,t175,t167,t176,t172,t165,et9+et10,t166,t174,t169,t178,t175,t166,et11+et12],(6,6))
        return W

    def dW_dphi_fcn(self, x):
        # This function was generated by the Symbolic Math Toolbox version 24.2.
        # 01-Oct-2025 19:12:39

        x3 = x[2]
        x4 = x[3]
        t2 = x3**2
        t3 = x3**3
        t4 = x4**2
        t5 = x4**3
        t6 = x3*4.565390503367883e-2
        t7 = x3*5.250948715578112e-1
        t8 = x3*4.73712180574749e-1
        t9 = x3*x4*2.568548900451981e-4
        t10 = x3*6.868842857213644e-3
        t11 = x4*1.697674770698767e-2
        t12 = x4*6.182827226867728e-2
        t13 = x3*2.678599020009083e-2
        t14 = x4*3.088260798307534e-2
        t15 = x4*1.932853687393836e-2
        t16 = x4*1.017815691162648e-2
        t17 = x3*1.111335248692567e-1
        t22 = x4*1.526301233166128e-2
        t23 = x3*x4*6.565316948548942e-2
        t25 = x3*x4*2.888824318599042e-2
        t27 = x3*x4*3.283690207800977e-2
        t28 = x3*x4*2.703950480169294e-2
        t29 = x3*9.592340217633501e-3
        t31 = x3*x4*2.511383744994898e-3
        t33 = x4*8.400476206521231e-4
        t44 = x3*x4*1.4316436961445e-2
        t81 = x3*x4*9.889512863444997e-5
        t18 = -t10
        t19 = -t13
        t20 = t2*x4*2.547827374313527e-2
        t21 = t3*3.400438384688112e-2
        t24 = -t15
        t26 = t2*x4*1.195421509514752e-2
        t30 = -t16
        t32 = t4*1.966789912731904e-3
        t34 = t3*1.715765119979148e-2
        t36 = t3*3.152336968543441e-2
        t37 = t3*1.978736203080602e-2
        t38 = t3*2.163686819695014e-2
        t40 = -t23
        t41 = -t25
        t43 = -t27
        t45 = t2*3.069725234136306e-3
        t46 = t4*x3*1.072017342457426e-2
        t47 = t5*1.009078512843227e-3
        t48 = t4*7.84114702035474e-3
        t49 = t3*2.737156956360142e-3
        t50 = -t31
        t51 = t4*2.003123980704729e-3
        t53 = t5*1.948509483780456e-3
        t54 = t2*2.749049722952853e-1
        t55 = t4*7.617631260080955e-3
        t56 = t2*1.69645652618116e-3
        t57 = t4*2.270712046926795e-3
        t59 = t4*8.152972546693492e-3
        t60 = t5*2.057656028268337e-3
        t61 = t4*2.084744717401233e-3
        t62 = t2*3.055772015671191e-1
        t63 = t2*7.663547574377792e-2
        t65 = t4*x3*8.025406431693477e-4
        t67 = t2*4.507180238226087e-2
        t70 = t5*8.743209875113441e-5
        t71 = t2*2.160070480261083e-2
        t75 = t4*3.893541189645826e-4
        t76 = t4*x3*1.519922876917288e-3
        t78 = t4*x3*4.519216105267557e-3
        t79 = t2*3.054227143481692e-3
        t80 = t3*1.275696413419504e-4
        t82 = t4*x3*1.471089223288084e-3
        t84 = t4*x3*1.411029865811303e-2
        t86 = t2*x4*2.675334048850031e-3
        t87 = t2*x4*7.393215813980498e-3
        t89 = t5*1.25361383468709e-5
        t92 = t5*5.594324170607154e-5
        t93 = t2*x4*6.774384310487366e-3
        t95 = t2*x4*1.800010390167577e-2
        t97 = t5*8.847889077426333e-5
        t98 = t2*x4*1.850097694244967e-3
        t102 = t4*x3*7.590938013623409e-5
        t35 = -t20
        t39 = -t21
        t42 = -t26
        t52 = -t32
        t58 = -t36
        t64 = -t46
        t66 = -t47
        t68 = -t49
        t69 = -t51
        t72 = -t53
        t73 = -t55
        t74 = -t56
        t77 = -t57
        t83 = -t60
        t85 = -t62
        t88 = -t65
        t90 = -t70
        t91 = -t71
        t94 = -t79
        t96 = -t87
        t99 = -t92
        t100 = -t93
        t101 = -t95
        t103 = -t102
        t104 = t9+t54+t59-3.754111810357057e-1
        t106 = t28+t48+t63-8.038573019788425e-2
        t105 = t43+t45+t52-5.176977055420184e-2
        t107 = t41+t69+t85+5.520526747556119e-1
        t108 = t61+t81+t94-8.817349728101803e-3
        t109 = t40+t67+t73-1.381518607209945e-2
        t110 = t50+t74+t75+2.71666514078285e-3
        t111 = t44+t77+t91+2.468149939815271e-3
        t112 = t6+t12+t34+t35+t64+t72
        t113 = t7+t11+t38+t78+t89+t96
        t114 = t8+t30+t37+t66+t84+t100
        t115 = t14+t17+t39+t76+t83+t101
        t116 = t18+t22+t42+t58+t82+t99
        t117 = t19+t24+t68+t88+t97+t98
        t118 = t29+t33+t80+t86+t90+t103
        et1 = t3*(-1.208788229887943e-1)-t5*1.12921984499217e-3+x3*1.958069588243191e-2+x4*2.609774161352688e-3-t2*x4*3.554245476144953e-2
        et2 = t4*x3*(-3.687629950521345e-3)
        et3 = t3*(-2.091829043030826e-2)-t5*1.839156124351175e-3+x3*6.743629902230242e-3-x4*1.459731339295602e-2-t2*x4*1.524883817658937e-2
        et4 = t4*x3*8.24845822357034e-4
        et5 = t3*9.354941910831423e-4-t5*9.997075268551635e-5+x3*2.192499595717527e-4-x4*2.360288935552951e-3+t2*x4*6.60443822959965e-4
        et6 = t4*x3*(-6.779580539306214e-5)
        et7 = t3*(-2.96984897227332e-3)-t5*9.993018930027982e-4-x3*2.312101311529512e-1-x4*1.185326697857637e-1+t2*x4*1.274190173834789e-2
        et8 = t4*x3*2.853911129052129e-3
        et9 = t3*(-2.572648208246082e-2)+t5*1.090271658163891e-3+x3*1.387649846400217e-1+x4*6.336217614119808e-3-t2*x4*2.75856439713151e-2
        et10 = t4*x3*4.181708342602251e-3
        et11 = t3*(-2.451914129225402e-2)+t5*6.381641569787065e-4-x3*1.288437588540791e-1+x4*1.127056659881137e-2-t2*x4*1.903195363241138e-2
        et12 = t4*x3*(-3.758237924670212e-3)
        dW_dphi = np.reshape([et1+et2,t111,t118,t113,t107,t115,t111,et3+et4,t108,t104,t114,t105,t118,t108,et5+et6,t117,t110,t116,t113,t104,t117,et7+et8,t106,t112,t107,t114,t110,t106,et9+et10,t109,t115,t105,t116,t112,t109,et11+et12],(6,6))
        return dW_dphi
    
    def dW_dvx_fcn(self, x):
        # This function was generated by the Symbolic Math Toolbox version 24.2.
        # 01-Oct-2025 19:12:39

        x3 = x[2]
        x4 = x[3]
        t2 = x3**2
        t3 = x3**3
        t4 = x4**2
        t5 = x4**3
        t6 = x4*1.797670514984008e-3
        t7 = x3*1.697674770698767e-2
        t8 = x3*6.182827226867728e-2
        t9 = x3*3.088260798307534e-2
        t13 = x3*1.932853687393836e-2
        t14 = x3*1.017815691162648e-2
        t15 = x3*x4*4.169489434802467e-3
        t16 = x3*x4*1.568229404070948e-2
        t17 = x3*x4*3.933579825463808e-3
        t18 = x4*2.249910727661363e-3
        t19 = x3*x4*1.523526252016191e-2
        t21 = x4*3.141942979169201e-3
        t22 = x4*1.924811486701346e-3
        t23 = x3*1.526301233166128e-2
        t24 = x3*x4*1.630594509338698e-2
        t27 = x4*1.320045537792915e-3
        t28 = x4*1.32073844764907e-3
        t30 = x4*5.507572762774286e-4
        t31 = x3*x4*4.006247961409457e-3
        t33 = x3*8.400476206521231e-4
        t35 = x3*x4*4.541424093853589e-3
        t49 = x3*x4*7.787082379291651e-4
        t10 = t3*3.984738365049173e-3
        t11 = t3*8.492757914378424e-3
        t12 = t2*1.28427445022599e-4
        t26 = -t13
        t29 = -t14
        t32 = -t17
        t34 = -t19
        t36 = t2*3.282658474274471e-2
        t37 = t3*8.917780162833438e-4
        t38 = -t21
        t39 = t2*1.444412159299521e-2
        t40 = t2*1.641845103900489e-2
        t41 = t2*1.351975240084647e-2
        t42 = -t27
        t43 = t2*x4*1.072017342457426e-2
        t44 = t2*1.255691872497449e-3
        t45 = t4*3.635361650776328e-3
        t46 = t3*6.000034633891925e-3
        t47 = -t31
        t48 = t3*2.258128103495789e-3
        t50 = -t35
        t54 = t2*7.158218480722502e-3
        t55 = t4*4.335171407189357e-3
        t56 = t3*2.464405271326833e-3
        t58 = t2*x4*8.025406431693477e-4
        t59 = t4*4.175095680154648e-3
        t62 = t4*2.361260349833131e-3
        t64 = t4*x3*3.02723553852968e-3
        t65 = t5*5.673445661618751e-4
        t66 = t2*x4*1.519922876917288e-3
        t67 = t5*5.416638443686593e-4
        t69 = t2*x4*4.519216105267557e-3
        t70 = t5*1.506395021797484e-4
        t71 = t2*x4*1.471089223288084e-3
        t72 = t3*6.166992314149889e-4
        t73 = t5*1.351203058548062e-4
        t74 = t2*x4*1.411029865811303e-2
        t77 = t4*5.004565242383061e-4
        t79 = t5*8.93673252729902e-5
        t81 = t4*6.094407454884213e-4
        t84 = t5*7.075974915016167e-5
        t85 = t4*6.882113323482989e-4
        t86 = t2*4.944756431722498e-5
        t87 = t4*5.979686343944355e-4
        t88 = t4*x3*6.172968084805012e-3
        t89 = t5*4.898928327155026e-5
        t90 = t4*x3*2.622962962534032e-4
        t91 = t4*x3*5.845528451341369e-3
        t100 = t2*x4*7.590938013623409e-5
        t101 = t4*x3*1.678297251182146e-4
        t102 = t4*x3*3.76084150406127e-5
        t104 = t4*x3*2.6543667232279e-4
        t20 = -t10
        t25 = -t11
        t51 = -t36
        t52 = -t39
        t53 = -t40
        t57 = -t43
        t60 = -t44
        t61 = -t45
        t63 = -t46
        t68 = -t48
        t75 = -t55
        t76 = -t56
        t78 = -t58
        t80 = -t62
        t82 = -t64
        t83 = -t65
        t92 = -t79
        t93 = -t84
        t94 = -t85
        t95 = -t87
        t96 = -t88
        t97 = -t89
        t98 = -t90
        t99 = -t91
        t103 = -t100
        t105 = -t101
        t106 = t12+t24+t77+1.410158690747415e-3
        t111 = t50+t54+t81-1.039626686860925e-2
        t107 = t16+t41+t80-6.703954090296202e-2
        t108 = t34+t51+t61+5.359068315436828e-2
        t109 = t47+t52+t75+1.680644965286592e-2
        t110 = t32+t53+t59-1.416584797695177e-2
        t112 = t15+t86+t95-5.059459614259174e-4
        t113 = t49+t60+t94-1.832283908920733e-2
        t114 = t8+t25+t28+t57+t70+t99
        t115 = t6+t7+t67+t69+t76+t102
        t116 = t20+t22+t23+t71+t93+t105
        t117 = t18+t29+t68+t74+t82+t92
        t118 = t9+t38+t63+t66+t83+t96
        t119 = t30+t33+t37+t73+t98+t103
        t120 = t26+t42+t72+t78+t97+t104
        et1 = t3*(-1.184748492048318e-2)-t5*4.999570921134343e-4+x3*2.609774161352688e-3+x4*4.192508080653695e-3-t2*x4*3.687629950521345e-3
        et2 = t4*x3*(-3.387659534976511e-3)
        et3 = t3*(-5.082946058863124e-3)+t5*1.816912152570769e-4-x3*1.459731339295602e-2+x4*4.216256874062727e-3+t2*x4*8.24845822357034e-4
        et4 = t4*x3*(-5.517468373053524e-3)
        et5 = t3*2.20147940986655e-4+t5*4.22393440123253e-6-x3*2.360288935552951e-3-x4*3.779786435633242e-4-t2*x4*6.779580539306214e-5
        et6 = t4*x3*(-2.999122580565491e-4)
        et7 = t3*4.247300579449297e-3-t5*7.692647181802526e-5-x3*1.185326697857637e-1-x4*1.152237200589473e-2+t2*x4*2.853911129052129e-3
        et8 = t4*x3*(-2.997905679008395e-3)
        et9 = t3*(-9.195214657105032e-3)+t5*7.532544349190657e-4+x3*6.336217614119808e-3+x4*2.649323386544309e-3+t2*x4*4.181708342602251e-3
        et10 = t4*x3*3.270814974491672e-3
        et11 = t3*(-6.343984544137128e-3)-t5*7.399545797909336e-4+x3*1.127056659881137e-2+x4*9.660730645677563e-4-t2*x4*3.758237924670212e-3
        et12 = t4*x3*1.914492470936119e-3
        dW_dvx = np.reshape([et1+et2,t111,t119,t115,t109,t118,t111,et3+et4,t112,t106,t117,t110,t119,t112,et5+et6,t120,t113,t116,t115,t106,t120,et7+et8,t107,t114,t109,t117,t113,t107,et9+et10,t108,t118,t110,t116,t114,t108,et11+et12],(6,6))
        return dW_dvx
    
    def dW_dxi_fcn(self, i, x, a_hat = None):
        #dW_dxi = (i==3) * self.dW_dphi_fcn(x) + (i==4) * self.dW_dvx_fcn(x)
        if i == 2:
            return self.dW_dphi_fcn(x)
        elif i == 3:
            return self.dW_dvx_fcn(x)
        else:
            return np.zeros((6, 6))

    """

    # CCM functions by Sihang Wei
    def w_poly_fnc(self, x):
        """
        Compute the polynomial basis function for a single point x.

        Parameters:
            x (ndarray): Input array of shape (2,), representing a single 2D point.

        Returns:
            ndarray: Polynomial terms evaluated at x, shape (3,).
        """
        # Compute the terms
        term1 = 1.0  # Constant term
        term2 = x[3]
        term3 = x[3] ** 2
        term4 = x[3] ** 3
        term5 = x[3] ** 4
        term6 = x[2]
        term7 = x[2] * x[3]
        term8 = x[2] * (x[3] ** 2)
        term9 = x[2] * (x[3] ** 3)
        term10 = x[2] ** 2
        term11 = x[2] ** 2 * x[3]
        term12 = (x[2] ** 2) * (x[3] ** 2)
        term13 = x[2] ** 3
        term14 = x[2] ** 3 * x[3]
        term15 = x[2] ** 4

        # Return as a vector
        return np.array([term1, term2, term3, term4, term5, term6, term7, term8, term9,
                        term10, term11, term12, term13, term14, term15])

    def dw_poly_p_fnc(self, x):
        """
        Compute the gradient of polynomial basis function for a single point x with respect to phi (x[2]).

        Parameters:
            x (ndarray): Input array of shape (2,), representing a single 2D point.

        Returns:
            ndarray: Gradient of polynomial terms evaluated at x, shape (3,).
        """
        # Compute the terms
        term1 = 0.0  # Constant term
        term2 = 0.0
        term3 = 0.0
        term4 = 0.0
        term5 = 0.0
        term6 = 1
        term7 = x[3]
        term8 = x[3] ** 2
        term9 = x[3] ** 3
        term10 = 2 * x[2]
        term11 = 2 * x[2] * x[3]
        term12 = 2 * x[2] * x[3] ** 2
        term13 = 3 * x[2] ** 2
        term14 = 3 * x[2] ** 2 * x[3]
        term15 = 4 * x[2] ** 3

        # Return as a vector
        return np.array([term1, term2, term3, term4, term5, term6, term7, term8, term9,
                        term10, term11, term12, term13, term14, term15])

    def dw_poly_vx_fnc(self, x):
        """
        Compute the gradient of polynomial basis function for a single point x with respect to vx (x[3]).

        Parameters:
            x (ndarray): Input array of shape (2,), representing a single 2D point.

        Returns:
            ndarray: Gradient of polynomial terms evaluated at x, shape (3,).
        """
        # Compute the terms
        term1 = 0.0  # Constant term
        term2 = 1.0
        term3 = 2 * x[3]
        term4 = 3 * x[3] ** 2
        term5 = 4 * x[3] ** 3
        term6 = 0.0
        term7 = x[2]
        term8 = 2 * x[2] * x[3]
        term9 = 3 * x[2] * x[3] ** 2
        term10 = 0.0
        term11 = x[2] ** 2
        term12 = 2 * (x[2] ** 2) * x[3]
        term13 = 0.0
        term14 = x[2] ** 3
        term15 = 0.0

        # Return as a vector
        return np.array([term1, term2, term3, term4, term5, term6, term7, term8, term9,
                        term10, term11, term12, term13, term14, term15])

    def W_fcn(self, x, a_hat = None):
        """
        Compute the matrix W(x) using the polynomial basis and coefficient matrices.

        Parameters:
            x (ndarray): Input array of shape (2,), representing a single 2D point.

        Returns:
            ndarray: The evaluated matrix W(x), shape (m, m).
        """
        # Compute the polynomial terms
        ml = self.w_poly_fnc(x)  # Shape (10,)

        # Define w_sol as a 3D array of coefficient matrices (m x m x 3)
        w_sol = np.zeros((6, 6, 15))

        w_sol[:, :, 0] = np.array([[ 59.7811,         0,   -2.4913,  -58.7629,         0,   -4.6670],
                                [       0,   24.2930,         0,         0,  -28.7402,         0],
                                [ -2.4913,         0,    4.4859,   12.2837,         0,   -7.7089],
                                [-58.7629,         0,   12.2837,   98.3171,         0,   12.6226],
                                [       0,  -28.7402,         0,         0,   55.6148,         0],
                                [ -4.6670,         0,   -7.7089,   12.6226,         0,  141.6235]])

        w_sol[:, :, 1] = np.array([[         0,   -2.3756,         0,         0,    2.2274,         0],
                                [   -2.3756,         0,    0.1546,    1.6846,         0,   -2.2302],
                                [         0,    0.1546,         0,         0,   -1.9474,         0],
                                [         0,    1.6846,         0,         0,   -6.7509,         0],
                                [    2.2274,         0,   -1.9474,   -6.7509,         0,    7.3687],
                                [         0,   -2.2302,         0,         0,    7.3687,         0]])

        w_sol[:, :, 2] = np.array([[    0.0129,         0,    0.1382,    0.6871,         0,   -0.7682],
                                [         0,   -0.3462,         0,         0,    0.8505,         0],
                                [    0.1382,         0,   -0.0767,   -0.3165,         0,    0.2142],
                                [    0.6871,         0,   -0.3165,   -1.8349,         0,    0.9014],
                                [         0,    0.8505,         0,         0,         0,         0],
                                [   -0.7682,         0,    0.2142,    0.9014,         0,   -0.4765]])

        w_sol[:, :, 3] = np.array([[         0,    0.0500,         0,         0,   -0.3056,         0],
                                [    0.0500,         0,         0,   -0.0016,         0,    0.0206],
                                [         0,         0,         0,         0,   -0.0232,         0],
                                [         0,   -0.0016,         0,         0,   -0.0323,         0],
                                [   -0.3056,         0,   -0.0232,   -0.0323,         0,   -0.5351],
                                [         0,    0.0206,         0,         0,   -0.5351,         0]])

        w_sol[:, :, 4] = np.array([[    0.0171,         0,         0,   -0.0165,         0,    0.0504],
                                [         0,    0.0090,         0,         0,   -0.0205,         0],
                                [         0,         0,         0,         0,         0,    0.0134],
                                [   -0.0165,         0,         0,         0,         0,   -0.0231],
                                [         0,   -0.0205,         0,         0,   -0.1600,         0],
                                [    0.0504,         0,    0.0134,   -0.0231,         0,    0.0400]])

        w_sol[:, :, 5] = np.array([[         0,   -3.8781,         0,         0,   68.6439,         0],
                                [   -3.8781,         0,    0.2504,  -23.8834,         0,   -7.6681],
                                [         0,    0.2504,         0,         0,   -3.6136,         0],
                                [         0,  -23.8834,         0,         0,  -35.5436,         0],
                                [   68.6439,         0,   -3.6136,  -35.5436,         0,    9.6703],
                                [         0,   -7.6681,         0,         0,    9.6703,         0]])

        w_sol[:, :, 6] = np.array([[    0.9487,         0,    0.2808,    1.7701,         0,    0.7379],
                                [         0,   -2.2450,         0,         0,    0.8250,         0],
                                [    0.2808,         0,   -0.2861,   -2.5455,         0,    3.5519],
                                [    1.7701,         0,   -2.5455,  -13.2201,         0,   16.3752],
                                [         0,    0.8250,         0,         0,    0.4333,         0],
                                [    0.7379,         0,    3.5519,   16.3752,         0,  -13.6703]])

        w_sol[:, :, 7] = np.array([[      0,    0.4079,         0,         0,   -0.6476,         0],
                                [ 0.4079,         0,         0,    0.3028,         0,   -0.2221],
                                [      0,         0,         0,         0,    0.6328,         0],
                                [      0,    0.3028,         0,         0,    1.6323,         0],
                                [-0.6476,         0,    0.6328,    1.6323,         0,   -3.5098],
                                [      0,   -0.2221,         0,         0,   -3.5098,         0]])

        w_sol[:, :, 8] = np.array([[    -0.1157,         0,         0,   -0.1663,         0,    0.2268],
                                [          0,   -0.4388,         0,         0,   -0.1623,         0],
                                [          0,         0,         0,         0,         0,   -0.0618],
                                [    -0.1663,         0,         0,         0,         0,   -0.7500],
                                [          0,   -0.1623,         0,         0,    2.4130,         0],
                                [     0.2268,         0,   -0.0618,   -0.7500,         0,    0.9879]])

        w_sol[:, :, 9] = np.array([[    3.0323,         0,   -0.2471,   31.0093,         0,    5.3489],
                                [         0,   -6.1252,         0,         0,   25.1742,         0],
                                [   -0.2471,         0,   -0.1266,   -2.4632,         0,    0.3108],
                                [   31.0093,         0,   -2.4632,  -35.7182,         0,    7.6304],
                                [         0,   25.1742,         0,         0,   10.1172,         0],
                                [    5.3489,         0,    0.3108,    7.6304,         0,   -5.9720]])

        w_sol[:, :, 10] = np.array([[         0,    1.9745,         0,         0,   -3.1818,         0],
                                    [    1.9745,         0,         0,    0.1349,         0,    1.2828],
                                    [         0,         0,         0,         0,   -0.7938,         0],
                                    [         0,    0.1349,         0,         0,    1.1090,         0],
                                    [   -3.1818,         0,   -0.7938,    1.1090,         0,   -0.7321],
                                    [         0,    1.2828,         0,         0,   -0.7321,         0]])

        w_sol[:, :, 11] = np.array([[   -0.1663,         0,         0,    0.0915,         0,   -0.5411],
                                    [         0,    0.8912,         0,         0,    0.1025,         0],
                                    [         0,         0,         0,         0,         0,   -0.0835],
                                    [    0.0915,         0,         0,         0,         0,   -1.6987],
                                    [         0,    0.1025,         0,         0,    3.8573,         0],
                                    [   -0.5411,         0,   -0.0835,   -1.6987,         0,   -1.4585]])

        w_sol[:, :, 12] = np.array([[         0,   -0.4114,         0,         0,  -16.0645,         0],
                                    [   -0.4114,         0,         0,   11.2453,         0,    0.5136],
                                    [         0,         0,         0,         0,   -1.0092,         0],
                                    [         0,   11.2453,         0,         0,    6.6411,         0],
                                    [  -16.0645,         0,   -1.0092,    6.6411,         0,   -4.9136],
                                    [         0,    0.5136,         0,         0,   -4.9136,         0]])

        w_sol[:, :, 13] = np.array([[   -1.2986,         0,         0,   -0.5780,         0,   -1.3967],
                                    [         0,   -1.0985,         0,         0,   -0.5766,         0],
                                    [         0,         0,         0,         0,         0,   -3.3418],
                                    [   -0.5780,         0,         0,         0,         0,  -10.0325],
                                    [         0,   -0.5766,         0,         0,   -7.6150,         0],
                                    [   -1.3967,         0,   -3.3418,  -10.0325,         0,   21.8314]])

        w_sol[:, :, 14] = np.array([[   -1.4620,         0,         0,   -1.2454,         0,    1.4526],
                                    [         0,   -0.0691,         0,         0,   -1.2454,         0],
                                    [         0,         0,         0,         0,         0,   -0.6911],
                                    [   -1.2454,         0,         0,         0,         0,   -6.2694],
                                    [         0,   -1.2454,         0,         0,    0.0024,         0],
                                    [    1.4526,         0,   -0.6911,   -6.2694,         0,   -9.6017]])

        # Compute W(x) as a weighted sum of the coefficient matrices
        term_num = ml.shape[-1]
        W_x = sum(w_sol[:, :, i] * ml[i] for i in range(term_num))

        return W_x

    def dW_dxi_fcn(self, i, x, a_hat = None):
        """
        Compute the gradient of the polynomial basis function with respect to a specific state variable.

        This replicates the MATLAB anonymous function:
        dW_dxi_fnc = @(i,x) (i==3)*dw_poly_p_fnc(x) + (i==4)*dw_poly_vx_fnc(x)

        Parameters:
            i (int): The index specifying the state variable derivative (e.g., 3 for phi, 4 for vx).
            x (ndarray): The state vector (expected to have at least 4 elements).

        Returns:
            ndarray: The computed gradient (shape (15,)). If i is neither 3 nor 4,
                    a zero vector is returned.
        """
        # Define w_sol as a 3D array of coefficient matrices (m x m x 3)
        w_sol = np.zeros((6, 6, 15))

        w_sol[:, :, 0] = np.array([[ 59.7811,         0,   -2.4913,  -58.7629,         0,   -4.6670],
                                [       0,   24.2930,         0,         0,  -28.7402,         0],
                                [ -2.4913,         0,    4.4859,   12.2837,         0,   -7.7089],
                                [-58.7629,         0,   12.2837,   98.3171,         0,   12.6226],
                                [       0,  -28.7402,         0,         0,   55.6148,         0],
                                [ -4.6670,         0,   -7.7089,   12.6226,         0,  141.6235]])

        w_sol[:, :, 1] = np.array([[         0,   -2.3756,         0,         0,    2.2274,         0],
                                [   -2.3756,         0,    0.1546,    1.6846,         0,   -2.2302],
                                [         0,    0.1546,         0,         0,   -1.9474,         0],
                                [         0,    1.6846,         0,         0,   -6.7509,         0],
                                [    2.2274,         0,   -1.9474,   -6.7509,         0,    7.3687],
                                [         0,   -2.2302,         0,         0,    7.3687,         0]])

        w_sol[:, :, 2] = np.array([[    0.0129,         0,    0.1382,    0.6871,         0,   -0.7682],
                                [         0,   -0.3462,         0,         0,    0.8505,         0],
                                [    0.1382,         0,   -0.0767,   -0.3165,         0,    0.2142],
                                [    0.6871,         0,   -0.3165,   -1.8349,         0,    0.9014],
                                [         0,    0.8505,         0,         0,         0,         0],
                                [   -0.7682,         0,    0.2142,    0.9014,         0,   -0.4765]])

        w_sol[:, :, 3] = np.array([[         0,    0.0500,         0,         0,   -0.3056,         0],
                                [    0.0500,         0,         0,   -0.0016,         0,    0.0206],
                                [         0,         0,         0,         0,   -0.0232,         0],
                                [         0,   -0.0016,         0,         0,   -0.0323,         0],
                                [   -0.3056,         0,   -0.0232,   -0.0323,         0,   -0.5351],
                                [         0,    0.0206,         0,         0,   -0.5351,         0]])

        w_sol[:, :, 4] = np.array([[    0.0171,         0,         0,   -0.0165,         0,    0.0504],
                                [         0,    0.0090,         0,         0,   -0.0205,         0],
                                [         0,         0,         0,         0,         0,    0.0134],
                                [   -0.0165,         0,         0,         0,         0,   -0.0231],
                                [         0,   -0.0205,         0,         0,   -0.1600,         0],
                                [    0.0504,         0,    0.0134,   -0.0231,         0,    0.0400]])

        w_sol[:, :, 5] = np.array([[         0,   -3.8781,         0,         0,   68.6439,         0],
                                [   -3.8781,         0,    0.2504,  -23.8834,         0,   -7.6681],
                                [         0,    0.2504,         0,         0,   -3.6136,         0],
                                [         0,  -23.8834,         0,         0,  -35.5436,         0],
                                [   68.6439,         0,   -3.6136,  -35.5436,         0,    9.6703],
                                [         0,   -7.6681,         0,         0,    9.6703,         0]])

        w_sol[:, :, 6] = np.array([[    0.9487,         0,    0.2808,    1.7701,         0,    0.7379],
                                [         0,   -2.2450,         0,         0,    0.8250,         0],
                                [    0.2808,         0,   -0.2861,   -2.5455,         0,    3.5519],
                                [    1.7701,         0,   -2.5455,  -13.2201,         0,   16.3752],
                                [         0,    0.8250,         0,         0,    0.4333,         0],
                                [    0.7379,         0,    3.5519,   16.3752,         0,  -13.6703]])

        w_sol[:, :, 7] = np.array([[      0,    0.4079,         0,         0,   -0.6476,         0],
                                [ 0.4079,         0,         0,    0.3028,         0,   -0.2221],
                                [      0,         0,         0,         0,    0.6328,         0],
                                [      0,    0.3028,         0,         0,    1.6323,         0],
                                [-0.6476,         0,    0.6328,    1.6323,         0,   -3.5098],
                                [      0,   -0.2221,         0,         0,   -3.5098,         0]])

        w_sol[:, :, 8] = np.array([[    -0.1157,         0,         0,   -0.1663,         0,    0.2268],
                                [          0,   -0.4388,         0,         0,   -0.1623,         0],
                                [          0,         0,         0,         0,         0,   -0.0618],
                                [    -0.1663,         0,         0,         0,         0,   -0.7500],
                                [          0,   -0.1623,         0,         0,    2.4130,         0],
                                [     0.2268,         0,   -0.0618,   -0.7500,         0,    0.9879]])

        w_sol[:, :, 9] = np.array([[    3.0323,         0,   -0.2471,   31.0093,         0,    5.3489],
                                [         0,   -6.1252,         0,         0,   25.1742,         0],
                                [   -0.2471,         0,   -0.1266,   -2.4632,         0,    0.3108],
                                [   31.0093,         0,   -2.4632,  -35.7182,         0,    7.6304],
                                [         0,   25.1742,         0,         0,   10.1172,         0],
                                [    5.3489,         0,    0.3108,    7.6304,         0,   -5.9720]])

        w_sol[:, :, 10] = np.array([[         0,    1.9745,         0,         0,   -3.1818,         0],
                                    [    1.9745,         0,         0,    0.1349,         0,    1.2828],
                                    [         0,         0,         0,         0,   -0.7938,         0],
                                    [         0,    0.1349,         0,         0,    1.1090,         0],
                                    [   -3.1818,         0,   -0.7938,    1.1090,         0,   -0.7321],
                                    [         0,    1.2828,         0,         0,   -0.7321,         0]])

        w_sol[:, :, 11] = np.array([[   -0.1663,         0,         0,    0.0915,         0,   -0.5411],
                                    [         0,    0.8912,         0,         0,    0.1025,         0],
                                    [         0,         0,         0,         0,         0,   -0.0835],
                                    [    0.0915,         0,         0,         0,         0,   -1.6987],
                                    [         0,    0.1025,         0,         0,    3.8573,         0],
                                    [   -0.5411,         0,   -0.0835,   -1.6987,         0,   -1.4585]])

        w_sol[:, :, 12] = np.array([[         0,   -0.4114,         0,         0,  -16.0645,         0],
                                    [   -0.4114,         0,         0,   11.2453,         0,    0.5136],
                                    [         0,         0,         0,         0,   -1.0092,         0],
                                    [         0,   11.2453,         0,         0,    6.6411,         0],
                                    [  -16.0645,         0,   -1.0092,    6.6411,         0,   -4.9136],
                                    [         0,    0.5136,         0,         0,   -4.9136,         0]])

        w_sol[:, :, 13] = np.array([[   -1.2986,         0,         0,   -0.5780,         0,   -1.3967],
                                    [         0,   -1.0985,         0,         0,   -0.5766,         0],
                                    [         0,         0,         0,         0,         0,   -3.3418],
                                    [   -0.5780,         0,         0,         0,         0,  -10.0325],
                                    [         0,   -0.5766,         0,         0,   -7.6150,         0],
                                    [   -1.3967,         0,   -3.3418,  -10.0325,         0,   21.8314]])

        w_sol[:, :, 14] = np.array([[   -1.4620,         0,         0,   -1.2454,         0,    1.4526],
                                    [         0,   -0.0691,         0,         0,   -1.2454,         0],
                                    [         0,         0,         0,         0,         0,   -0.6911],
                                    [   -1.2454,         0,         0,         0,         0,   -6.2694],
                                    [         0,   -1.2454,         0,         0,    0.0024,         0],
                                    [    1.4526,         0,   -0.6911,   -6.2694,         0,   -9.6017]])

        # Get the polynomial gradient vector for the appropriate variable.
        if i == 2:
            poly_grad = self.dw_poly_p_fnc(x)
        elif i == 3:
            poly_grad = self.dw_poly_vx_fnc(x)
        else:
            poly_grad = np.zeros(15)

        # Initialize the output matrix using the shape of one coefficient slice.
        m = w_sol.shape[0]
        dW_dxi = np.zeros((m, m))

        # Multiply each coefficient matrix by the corresponding polynomial term and sum.
        for j in range(15):
            dW_dxi += w_sol[:, :, j] * poly_grad[j]

        return dW_dxi

    def dW_dai_fcn(self, i, x, a_hat = None):
        pass