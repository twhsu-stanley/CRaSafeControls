import sympy as sp
import numpy as np
from dynsys.ctrl_affine_sys import CtrlAffineSys

class PLANNAR_QUAD_UNCERTAIN(CtrlAffineSys):
    def __init__(self, params=None):
        super().__init__(params)
    
    def define_system_symbolic(self):
        # Symbolic states
        px, pz, phi, vx, vz, phi_dot = sp.symbols('px pz phi vx vz phi_dot')
        x = sp.Matrix([px, pz, phi, vx, vz, phi_dot])
        
        l = self.params['l'] # (m) half-width of quadrotor
        m = self.params['m'] # (kg) mass of the quadrotor
        grav = self.params['g'] # (m/s^2) gravity
        J = self.params['J'] # (kgm^2), moment of inertia

        f = sp.Matrix([
            x[3] * sp.cos(x[2]) - x[4] * sp.sin(x[2]),   # px_dot
            x[3] * sp.sin(x[2]) + x[4] * sp.cos(x[2]),   # pz_dot
            x[5],                                        # phi_dot
            x[5] * x[4] - grav * sp.sin(x[2]),           # vx_dot
            -x[5] * x[3] - grav * sp.cos(x[2]),          # vz_dot
            sp.Integer(0)                                # phi_ddot
        ])

        g = sp.Matrix([
            [0,              0],
            [0,              0],
            [0,              0],
            [0,              0],
            [1/m,            1/m],
            [l/J,           -l/J]
        ])

        return x, f, g
    
    def define_Y_symbolic(self, x):
        # Define the symbolic uncertainty term Y(x)
        Y = sp.Matrix([[0], 
                       [0],
                       [0],
                       [sp.cos(x[2])],
                       [-sp.sin(x[2])],
                       [0]])
        return Y

    def define_a_symbolic(self):
        # Symbolic states
        a0 = sp.symbols('a0')
        return sp.Matrix([a0])

    # CCM functions
    def W_fcn(self, x):
        pass

    def dW_dphi_fcn(self, x):
        # This function was generated by the Symbolic Math Toolbox version 24.2.
        # 01-Oct-2025 19:12:39

        x3 = x[2]
        x4 = x[3]
        t2 = x3 ** 2
        t3 = x3 ** 3
        t4 = x4 ** 2
        t5 = x4 ** 3
        t6 = x4 * 2.811437435514397e-2
        t7 = x3 * 6.142936316055314e-1
        t8 = x3 * 1.048990106735144
        t9 = x4 * 1.25519562212039e-1
        t10 = x3 * 9.104339345482795e-2
        t11 = x3 * x4 * 2.200907699127119e-1
        t12 = x3 * 2.478344345087368e-1
        t13 = x3 * 1.668544593064758e-1
        t14 = x3 * 6.194432556703583e-1
        t15 = x4 * 4.164667402603878e-2
        t16 = x4 * 3.735454405598647e-2
        t18 = x4 * 6.861307472574456e-2
        t19 = x3 * x4 * 1.698875065294977e-1
        t21 = x4 * 4.76446327203229e-2
        t24 = x4 * 5.736720509483684e-3
        t25 = x3 * x4 * 1.615194805437483e-2
        t27 = x3 * x4 * 4.150197481022192e-3
        t31 = x3 * 1.359108666584595e-2
        t32 = x3 * x4 * 3.198457766222456e-2
        t33 = x3 * x4 * 2.73201366822279e-2
        t36 = x3 * x4 * 1.068373129053819e-1
        t48 = x3 * x4 * 3.406334146928218e-3
        t17 = -t11
        t20 = -t12
        t22 = -t13
        t23 = -t15
        t26 = t2 * x4 * 6.302315568361277e-3
        t28 = t3 * 3.893829329379678e-1
        t29 = -t21
        t30 = t3 * 3.009287794232828e-1
        t34 = t3 * 1.634547874211748e-1
        t35 = t3 * 1.565426115349638e-1
        t37 = -t24
        t38 = t2 * x4 * 1.441480353372272e-1
        t39 = t4 * 1.063451110311813e-2
        t40 = -t25
        t41 = t3 * 7.322061592382346e-2
        t42 = t4 * 2.469880072491519e-2
        t43 = -t27
        t44 = t2 * 3.946732642747702e-1
        t45 = t2 * 5.121475022010973e-1
        t47 = -t32
        t49 = t3 * 1.189270065620298e-2
        t50 = t4 * x3 * 1.94927657874763e-2
        t51 = t4 * 3.193100543687839e-2
        t54 = t4 * 4.164401489215351e-3
        t55 = t5 * 3.353135806369892e-3
        t58 = t2 * x4 * 5.211981285111902e-2
        t59 = t5 * 2.851821903243477e-3
        t60 = t4 * 1.304446219863942e-3
        t62 = t2 * 1.463322730951255e-1
        t63 = t2 * 3.045037594131976e-1
        t64 = t2 * 2.796346762674071e-1
        t65 = t4 * 1.472682852214809e-2
        t66 = t4 * 2.644356187982254e-3
        t67 = t5 * 3.635365413591154e-3
        t69 = t3 * 1.581492409337515e-3
        t71 = t4 * x3 * 2.445493979998556e-2
        t72 = t2 * 2.85433751118621e-2
        t73 = t4 * x3 * 4.555275628530712e-3
        t74 = t4 * x3 * 1.199053620666533e-3
        t75 = t2 * x4 * 1.265135568301955e-1
        t76 = t2 * x4 * 3.291279891859903e-2
        t77 = t5 * 5.663801067668065e-4
        t82 = t2 * 1.269037022462948e-2
        t83 = t2 * 1.083293691972963e-2
        t85 = t4 * x3 * 6.353692514388722e-3
        t86 = t4 * 5.56974996550309e-4
        t87 = t5 * 5.951382757502021e-4
        t92 = t2 * x4 * 1.080743498559328e-2
        t93 = t4 * x3 * 2.004047299931539e-4
        t94 = t4 * x3 * 4.641720601686834e-4
        t95 = t2 * x4 * 2.060365840520164e-2
        t98 = t5 * 1.41508144194634e-5
        t99 = t5 * 1.434848132621115e-5
        t46 = -t30
        t52 = -t38
        t53 = -t39
        t56 = -t41
        t57 = -t42
        t61 = -t44
        t68 = -t49
        t70 = -t50
        t78 = -t55
        t79 = -t58
        t80 = -t59
        t81 = -t60
        t84 = -t67
        t88 = -t73
        t89 = -t74
        t90 = -t76
        t91 = -t77
        t96 = -t86
        t97 = -t87
        t100 = -t94
        t101 = -t99
        t103 = t19+t51+t62-4.270078340613826e-1
        t105 = t36+t63+t65-4.576682100463582e-1
        t107 = t40+t66+t83-2.063012754343378e-3
        t108 = t48+t54+t82-1.411359830838531e-2
        t102 = t17+t53+t61+1.037953691572463
        t104 = t45+t47+t57-2.432257336910554e-1
        t106 = t33+t64+t81-1.891646743225719e-1
        t109 = t43+t72+t96-2.210945559316524e-2
        t110 = t7+t16+t34+t71+t78+t90
        t111 = t20+t23+t28+t70+t75+t80
        t112 = t9+t14+t46+t52+t84+t93
        t113 = t8+t18+t35+t79+t85+t101
        t114 = t6+t31+t56+t89+t91+t95
        t115 = t22+t26+t29+t68+t88+t98
        t116 = t10+t37+t69+t92+t97+t100
        et1 = t3 * (-2.891399824216291e-1)-t5 * 2.622712880109643e-3+x3 * 8.617160390285733e-2+x4 * 8.764435833699385e-3-t2 * x4 * 8.627209829296998e-2
        et2 = t4 * x3 * (-1.737254026394414e-2)
        et3 = t3 * 8.213595399616754e-3-t5 * 3.823471416510863e-3+x3 * 1.09050081326172e-2-x4 * 2.077130679920566e-2-t2 * x4 * 3.939962241270607e-2
        et4 = t4 * x3 * (-1.004368308671538e-3)
        et5 = t3 * 1.998644698409814e-3-t5 * 1.028562692237775e-4-x3 * 1.725043695970045e-2-x4 * 1.33856244512918e-2+t2 * x4 * 1.541421583978384e-3
        et6 = t4 * x3 * (-1.499521465455675e-3)
        et7 = t3 * (-9.472683036470246e-3)-t5 * 4.220559201040223e-3-x3 * 1.215655599599601-x4 * 3.467853380068076e-1+t2 * x4 * 7.621636352651653e-2
        et8 = t4 * x3 * 1.537397864182784e-2
        et9 = t3 * (-3.914576281313076e-2)+t5 * 4.158677472242822e-3+x3 * 4.121633287949795e-1-x4 * 1.925024978807908e-2-t2 * x4 * 3.87863517452484e-2
        et10 = t4 * x3 * 1.665917925677854e-1
        et11 = t3 * 1.235428240297909e-1-t5 * 4.479186719035016e-3-x3 * 5.367873596538822e-1+x4 * 3.583630476868498e-2+t2 * x4 * 4.028585513692156e-2
        et12 = t4 * x3 * (-1.306494239950848e-2)
        dW_dphi = np.reshape([et1+et2,t109,t116,t113,t102,t112,t109,et3+et4,t108,t105,t110,t106,t116,t108,et5+et6,t115,t107,t114,t113,t105,t115,et7+et8,t103,t111,t102,t110,t107,t103,et9+et10,t104,t112,t106,t114,t111,t104,et11+et12],(6,6))
        return dW_dphi
    
    def dW_dvx_fcn(self, x):
        pass
    
    def dW_dxi_fcn(self, i, x):
        if i == 2:
            return self.dW_dphi_fcn(x)
        elif i == 3:
            return self.dW_dvx_fcn(x)
        else:
            return np.zeros((6, 6))

    def dW_da0_fcn(self,x):
        pass

    def dW_dai_fcn(self, i, x):
        if i == 0:
            return self.dW_da0_fcn(x)